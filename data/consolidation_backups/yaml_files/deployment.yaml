# Deployment Configuration
# Docker, Kubernetes, and deployment-specific settings

# Docker Configuration
docker:
  backend:
    image: "contract-analyzer-backend"
    tag: "latest"
    dockerfile: "deployment/docker/Dockerfile.backend"
    build_context: "."
    ports:
      - "8002:8002"
    volumes:
      - "./data:/backend/app/data"
      - "./logs:/backend/app/logs"
      - "./secrets:/backend/app/secrets"
    environment:
      - "ENVIRONMENT=production"
      - "DATABASE_URL=sqlite+aiosqlite:///./data/contract_analyzer.db"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: "30s"
      timeout: "10s"
      retries: 3
      start_period: "40s"
    restart_policy: "unless-stopped"
    
  frontend:
    image: "contract-analyzer-frontend"
    tag: "latest"
    dockerfile: "deployment/docker/Dockerfile.frontend"
    build_context: "."
    ports:
      - "8501:8501"
    volumes:
      - "./data:/backend/app/data"
      - "./logs:/backend/app/logs"
    environment:
      - "BACKEND_URL=http://backend:8002"
      - "STREAMLIT_SERVER_PORT=8501"
    depends_on:
      - "backend"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: "30s"
      timeout: "10s"
      retries: 3
      start_period: "40s"
    restart_policy: "unless-stopped"

# Docker Compose Configuration
compose:
  version: "3.8"
  networks:
    contract_analyzer:
      driver: bridge
  volumes:
    data:
      driver: local
    logs:
      driver: local
    prometheus_data:
      driver: local
    grafana_data:
      driver: local

# Kubernetes Configuration
kubernetes:
  namespace: "contract-analyzer"
  replicas:
    backend: 3
    frontend: 2
  resources:
    backend:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "2Gi"
        cpu: "1000m"
    frontend:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "1Gi"
        cpu: "500m"
  ingress:
    enabled: true
    class: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - host: "contract-analyzer.example.com"
        paths:
          - path: "/"
            service: "frontend"
            port: 8501
          - path: "/api"
            service: "backend"
            port: 8002
    tls:
      - secretName: "contract-analyzer-tls"
        hosts:
          - "contract-analyzer.example.com"

# Health Checks
health_checks:
  backend:
    endpoint: "/health"
    interval: 30
    timeout: 10
    retries: 3
    healthy_threshold: 2
    unhealthy_threshold: 3
  frontend:
    endpoint: "/_stcore/health"
    interval: 30
    timeout: 10
    retries: 3
    healthy_threshold: 2
    unhealthy_threshold: 3

# Scaling Configuration
scaling:
  auto_scaling:
    enabled: false
    min_replicas: 1
    max_replicas: 10
    target_cpu_utilization: 70
    target_memory_utilization: 80
  horizontal_pod_autoscaler:
    enabled: false
    metrics:
      - type: "Resource"
        resource:
          name: "cpu"
          target:
            type: "Utilization"
            averageUtilization: 70
      - type: "Resource"
        resource:
          name: "memory"
          target:
            type: "Utilization"
            averageUtilization: 80

# Load Balancing
load_balancing:
  strategy: "round_robin"
  session_affinity: false
  health_check_path: "/health"
  timeout: 30
  retries: 3

# SSL/TLS Configuration
ssl:
  enabled: true
  cert_path: "./secrets/ssl/certificate.crt"
  key_path: "./secrets/ssl/private.key"
  ca_path: "./secrets/ssl/ca.crt"
  protocols: ["TLSv1.2", "TLSv1.3"]
  ciphers: "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
  
# Backup Configuration
backup:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention_days: 30
  storage_path: "data/backups"
  compress: true
  encryption: true
  destinations:
    local:
      enabled: true
      path: "data/backups"
    s3:
      enabled: false
      bucket: "contract-analyzer-backups"
      region: "us-east-1"
      access_key_id: "${AWS_ACCESS_KEY_ID}"
      secret_access_key: "${AWS_SECRET_ACCESS_KEY}"

# Environment-specific Overrides
environments:
  development:
    docker:
      backend:
        ports:
          - "8002:8002"
        environment:
          - "ENVIRONMENT=development"
          - "DEBUG=true"
      frontend:
        ports:
          - "8501:8501"
        environment:
          - "BACKEND_URL=http://localhost:8002"
    ssl:
      enabled: false
    backup:
      enabled: false
      
  production:
    docker:
      backend:
        replicas: 3
        environment:
          - "ENVIRONMENT=production"
          - "DEBUG=false"
          - "WORKERS=8"
      frontend:
        replicas: 2
    kubernetes:
      replicas:
        backend: 5
        frontend: 3
    ssl:
      enabled: true
      protocols: ["TLSv1.3"]
    backup:
      enabled: true
      retention_days: 90
      destinations:
        s3:
          enabled: true
          
  staging:
    docker:
      backend:
        replicas: 2
        environment:
          - "ENVIRONMENT=staging"
      frontend:
        replicas: 1
    ssl:
      enabled: true
    backup:
      enabled: true
      retention_days: 14