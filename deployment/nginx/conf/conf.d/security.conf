# Enhanced Security Configuration for Nginx
# =============================================================================
# This file contains comprehensive security headers and configurations
# =============================================================================

# Security Headers
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()" always;

# Content Security Policy
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
    img-src 'self' data: https: blob:;
    font-src 'self' data: https://fonts.gstatic.com;
    connect-src 'self' ws: wss:;
    media-src 'self';
    object-src 'none';
    child-src 'none';
    frame-src 'none';
    worker-src 'self';
    manifest-src 'self';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
" always;

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Hide server information
server_tokens off;
more_clear_headers Server;
more_set_headers "Server: Contract-Analyzer";

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=global:10m rate=20r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

# Request size limits
client_max_body_size 10M;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# Timeout configurations
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 15;
send_timeout 10;

# Buffer overflow protection
client_body_buffer_size 128k;
client_header_buffer_size 1k;
client_max_body_size 10m;
large_client_header_buffers 2 1k;

# Disable unnecessary HTTP methods
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$ ) {
    return 405;
}

# Block common attack patterns
location ~* \.(php|asp|aspx|jsp|cgi)$ {
    return 444;
}

# Block access to sensitive files
location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf)$ {
    deny all;
    return 444;
}

# Block access to hidden files
location ~ /\. {
    deny all;
    return 444;
}

# Block access to backup files
location ~* \.(bak|backup|old|orig|save|swo|swp|tmp)$ {
    deny all;
    return 444;
}

# Prevent access to version control directories
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    return 444;
}

# Block user agents
if ($http_user_agent ~* (nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|havij|appscan)) {
    return 444;
}

# Block referrer spam
if ($http_referer ~* (babes|forsale|girl|jewelry|love|nudit|organic|poker|porn|sex|teen)) {
    return 444;
}

# Prevent image hotlinking
location ~* \.(gif|png|jpe?g)$ {
    valid_referers none blocked server_names ~\.google\. ~\.bing\. ~\.yahoo\.;
    if ($invalid_referer) {
        return 403;
    }
}

# Security for API endpoints
location /api/ {
    # Rate limiting
    limit_req zone=api burst=20 nodelay;
    limit_conn perip 10;
    
    # Additional security headers for API
    add_header X-API-Version "1.0" always;
    add_header X-Rate-Limit "10r/s" always;
    
    # CORS headers (adjust as needed)
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Max-Age' 1728000 always;
        add_header 'Content-Type' 'text/plain; charset=utf-8' always;
        add_header 'Content-Length' 0 always;
        return 204;
    }
}

# Security for authentication endpoints
location /api/v1/auth/ {
    limit_req zone=auth burst=5 nodelay;
    limit_conn perip 5;
    
    # Additional logging for auth attempts
    access_log /var/log/nginx/auth.log main;
}

# Security for file upload endpoints
location /api/v1/upload {
    limit_req zone=upload burst=3 nodelay;
    limit_conn perip 2;
    
    # Specific upload security
    client_max_body_size 10M;
    client_body_timeout 60s;
    
    # Additional logging for uploads
    access_log /var/log/nginx/upload.log main;
}

# Monitoring and health check endpoints (no rate limiting)
location ~ ^/(health|metrics|status)$ {
    access_log off;
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
}