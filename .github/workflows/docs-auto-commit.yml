name: Documentation Auto-Commit

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'scripts/**'
      - '!docs/**'  # Don't trigger on docs changes to avoid loops
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force documentation update'
        required: false
        type: boolean
        default: false

jobs:
  auto-commit-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && !contains(github.event.head_commit.message, 'docs:'))

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Python dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install fastapi sqlalchemy alembic

    - name: Install Node.js dependencies
      run: |
        cd frontend && npm ci
        npm install -g @apidevtools/swagger-cli typescript ts-node

    - name: Create scripts directory if missing
      run: mkdir -p scripts

    - name: Generate API documentation
      run: |
        echo "üîç Generating API documentation..."
        python scripts/analyze_api_endpoints.py || echo "API analysis failed, continuing..."
        python scripts/generate_openapi_docs.py || echo "OpenAPI generation failed, continuing..."

    - name: Analyze codebase
      run: |
        echo "üîç Analyzing database schema..."
        python scripts/analyze_database_schema.py || echo "Schema analysis failed, continuing..."

        echo "üîç Analyzing React components..."
        npx tsc scripts/analyze-components.ts --outDir dist --target ES2020 --module commonjs && node dist/scripts/analyze-components.js || echo "Component analysis failed, continuing..."

    - name: Validate and update diagrams
      run: |
        echo "üîç Validating architecture diagrams..."
        python scripts/update_architecture_diagrams.py || echo "Diagram validation failed, continuing..."

    - name: Check documentation health
      run: |
        echo "üè• Checking documentation health..."
        python scripts/monitor_docs_health.py || echo "Health check failed, continuing..."

    - name: Validate WikiLinks
      run: |
        echo "üîó Validating WikiLinks..."
        python scripts/check_wikilinks.py || echo "WikiLink validation failed, continuing..."

    - name: Check for documentation changes
      id: check_changes
      run: |
        if git diff --quiet docs/; then
          echo "No documentation changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Documentation changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          git diff --name-only docs/
        fi

    - name: Commit and push documentation changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add all documentation changes
        git add docs/

        # Create commit message with details
        CHANGED_FILES=$(git diff --cached --name-only docs/ | wc -l)
        COMMIT_MESSAGE="docs: Auto-update documentation [${CHANGED_FILES} files]

        Generated by GitHub Actions workflow
        Triggered by: ${{ github.event_name }}
        SHA: ${{ github.sha }}

        Files changed:
        $(git diff --cached --name-only docs/ | sed 's/^/- /')"

        # Commit the changes
        git commit -m "$COMMIT_MESSAGE"

        # Push the changes
        git push origin ${{ github.ref_name }}

        echo "‚úÖ Committed $CHANGED_FILES documentation files"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Documentation auto-commit failed"
        echo "Check the workflow logs for details"