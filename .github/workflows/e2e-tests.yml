name: End-to-End Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run E2E tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - workflow
          - performance
          - security
          - legacy
          - integration
          - system

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]
      fail-fast: false
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: contract_analyzer_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libpq-dev \
          python3-dev \
          curl \
          jq
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install pytest-timeout pytest-xdist pytest-json-report
        
    - name: Set up environment variables
      run: |
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/contract_analyzer_test" >> $GITHUB_ENV
        echo "BACKEND_URL=http://localhost:8000" >> $GITHUB_ENV
        echo "FRONTEND_URL=http://localhost:8501" >> $GITHUB_ENV
        echo "USE_TEST_CLIENT=true" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}:${{ github.workspace }}/backend" >> $GITHUB_ENV
        
    - name: Create test directories
      run: |
        mkdir -p logs/audit
        mkdir -p data/temp
        mkdir -p sample_contracts
        
    - name: Create sample contract files
      run: |
        cat > sample_contracts/sample_service_agreement.txt << 'EOF'
        SERVICE AGREEMENT
        
        This Service Agreement is entered into between ABC Company and XYZ Client.
        
        1. SERVICES
        The Company agrees to provide consulting services.
        
        2. PAYMENT TERMS
        Client shall pay Company $10,000 within 30 days.
        Late payments will incur a 5% penalty per month.
        
        3. TERMINATION
        Either party may terminate with 30 days notice.
        
        4. LIABILITY
        Company's liability shall not exceed the total amount paid.
        Client waives all claims for consequential damages.
        
        5. GOVERNING LAW
        This agreement shall be governed by California law.
        EOF
        
        cat > sample_contracts/high_risk_contract.txt << 'EOF'
        HIGH-RISK SERVICE AGREEMENT
        
        1. UNLIMITED LIABILITY
        Client assumes unlimited liability for all damages.
        
        2. IMMEDIATE TERMINATION
        Company may terminate immediately without notice.
        
        3. BROAD INDEMNIFICATION
        Client indemnifies Company against all claims.
        
        4. AUTOMATIC RENEWAL
        This agreement automatically renews for 5-year terms.
        EOF
        
    - name: Initialize database
      run: |
        cd backend
        python -c "
        import os
        os.environ['DATABASE_URL'] = 'postgresql://postgres:postgres@localhost:5432/contract_analyzer_test'
        from app.core.database import init_db
        init_db()
        "
        
    - name: Start backend server
      run: |
        cd backend
        python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        echo $! > backend.pid
        
        # Wait for backend to start
        for i in {1..30}; do
          if curl -f http://localhost:8000/api/v1/health; then
            echo "Backend is ready"
            break
          fi
          echo "Waiting for backend to start... ($i/30)"
          sleep 2
        done
        
    - name: Verify backend health
      run: |
        curl -f http://localhost:8000/api/v1/health || exit 1
        echo "Backend health check passed"
        
    - name: Run E2E tests - All Categories
        python -m tests.framework.orchestrator --all \
          --backend-url http://localhost:8000 \
          --frontend-url http://localhost:8501 \
          --use-test-client \
          --output ../../e2e_results_all.json \
          --html-report ../../e2e_report_all.html
          
    - name: Run E2E tests - Specific Category
      if: github.event.inputs.test_category != 'all' && github.event.inputs.test_category != ''
      run: |
        cd tests/e2e
        python -m tests.framework.orchestrator --category ${{ github.event.inputs.test_category }} \
          --backend-url http://localhost:8000 \
          --frontend-url http://localhost:8501 \
          --use-test-client \
          --category ${{ github.event.inputs.test_category }} \
          --output ../../e2e_results_${{ github.event.inputs.test_category }}.json \
          --html-report ../../e2e_report_${{ github.event.inputs.test_category }}.html
          
    - name: Run Workflow Tests
      run: |
        cd tests/e2e
        python -m pytest test_complete_workflows.py -v --tb=short --timeout=300
        
    - name: Run Performance Tests
      run: |
        cd tests/e2e
        python -m pytest test_performance_scalability.py -v --tb=short --timeout=600 -m "not slow"
        
    - name: Run Security Tests
      run: |
        cd tests/e2e
        python -m pytest test_security_vulnerabilities.py -v --tb=short --timeout=300
        
    - name: Run Legacy E2E Tests
      run: |
        cd backend/tests
        python -m pytest test_end_to_end_workflows.py -v --tb=short --timeout=300
        
    - name: Collect test artifacts
      if: always()
      run: |
        mkdir -p test-artifacts
        
        # Collect test results
        find . -name "*.json" -path "*/test*" -o -name "*test*.json" | head -10 | xargs -I {} cp {} test-artifacts/ 2>/dev/null || true
        find . -name "*.html" -path "*/test*" -o -name "*test*.html" | head -5 | xargs -I {} cp {} test-artifacts/ 2>/dev/null || true
        
        # Collect logs
        find . -name "*.log" | head -10 | xargs -I {} cp {} test-artifacts/ 2>/dev/null || true
        
        # Create summary
        echo "# E2E Test Summary" > test-artifacts/summary.md
        echo "- Python Version: ${{ matrix.python-version }}" >> test-artifacts/summary.md
        echo "- Test Category: ${{ github.event.inputs.test_category || 'all' }}" >> test-artifacts/summary.md
        echo "- Timestamp: $(date)" >> test-artifacts/summary.md
        
        # Backend logs
        if [ -f backend.pid ]; then
          echo "Backend process was running with PID: $(cat backend.pid)" >> test-artifacts/summary.md
        fi
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-test-results-python-${{ matrix.python-version }}
        path: test-artifacts/
        retention-days: 30
        
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-test-reports-python-${{ matrix.python-version }}
        path: |
          *.json
          *.html
        retention-days: 30
        
    - name: Stop backend server
      if: always()
      run: |
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) || true
          rm backend.pid
        fi
        
    - name: Generate test summary
      if: always()
      run: |
        echo "## E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Category:** ${{ github.event.inputs.test_category || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
        # Add results if available
        if [ -f e2e_results_all.json ]; then
          echo "- **Overall Success Rate:** $(jq -r '.summary.overall_success_rate // "N/A"' e2e_results_all.json)%" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** $(jq -r '.summary.duration_seconds // "N/A"' e2e_results_all.json)s" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Categories" >> $GITHUB_STEP_SUMMARY
        
        if [ -f e2e_results_all.json ]; then
          jq -r '.category_results | to_entries[] | "- **\(.key):** \(if .value.success then "✅ PASS" else "❌ FAIL" end)"' e2e_results_all.json >> $GITHUB_STEP_SUMMARY
        fi

  notify-results:
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.e2e-tests.result == 'success'
      run: |
        echo "✅ All E2E tests passed successfully!"
        
    - name: Notify on failure
      if: needs.e2e-tests.result == 'failure'
      run: |
        echo "❌ Some E2E tests failed. Please check the test results."
        exit 1