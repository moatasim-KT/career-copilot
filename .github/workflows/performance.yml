name: Performance Testing

on:
  schedule:
    - cron: '0 3 * * 0'  # Weekly on Sunday at 3 AM
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test-duration:
        description: 'Test duration in minutes'
        required: false
        default: '5'
        type: string
      user-count:
        description: 'Number of concurrent users'
        required: false
        default: '50'
        type: string

jobs:
  # =============================================================================
  # LOAD TESTING
  # =============================================================================
  load-test:
    name: Load Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust

    - name: Start test environment
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30  # Wait for services to be ready

    - name: Run load tests
      run: |
        cd backend
        locust -f tests/performance/locustfile.py \
          --headless \
          -u ${{ github.event.inputs.user-count || '50' }} \
          -r 10 \
          -t ${{ github.event.inputs.test-duration || '5' }}m \
          --html performance-report.html \
          --csv performance-results \
          --host http://localhost:8000

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: |
          backend/performance-report.html
          backend/performance-results_*.csv

    - name: Cleanup test environment
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # =============================================================================
  # STRESS TESTING
  # =============================================================================
  stress-test:
    name: Stress Testing
    runs-on: ubuntu-latest
    needs: load-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust

    - name: Start test environment
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30

    - name: Run stress tests
      run: |
        cd backend
        locust -f tests/performance/stress_test.py \
          --headless \
          -u 200 \
          -r 20 \
          -t 10m \
          --html stress-report.html \
          --csv stress-results \
          --host http://localhost:8000

    - name: Upload stress test results
      uses: actions/upload-artifact@v3
      with:
        name: stress-results
        path: |
          backend/stress-report.html
          backend/stress-results_*.csv

    - name: Cleanup test environment
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # =============================================================================
  # MEMORY LEAK TESTING
  # =============================================================================
  memory-test:
    name: Memory Leak Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install memory-profiler psutil

    - name: Start test environment
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30

    - name: Run memory leak tests
      run: |
        cd backend
        python tests/performance/memory_test.py

    - name: Upload memory test results
      uses: actions/upload-artifact@v3
      with:
        name: memory-results
        path: backend/memory-test-results.json

    - name: Cleanup test environment
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # =============================================================================
  # DATABASE PERFORMANCE TESTING
  # =============================================================================
  database-test:
    name: Database Performance Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psycopg2-binary

    - name: Start test environment
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30

    - name: Run database performance tests
      run: |
        cd backend
        python tests/performance/database_test.py

    - name: Upload database test results
      uses: actions/upload-artifact@v3
      with:
        name: database-results
        path: backend/database-test-results.json

    - name: Cleanup test environment
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # =============================================================================
  # PERFORMANCE REPORT GENERATION
  # =============================================================================
  performance-report:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    needs: [load-test, stress-test, memory-test, database-test]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate performance report
      run: |
        echo "# Performance Test Report" > performance-report.md
        echo "Generated on: $(date)" >> performance-report.md
        echo "" >> performance-report.md
        
        echo "## Load Test Results" >> performance-report.md
        if [ -f "performance-results/performance-report.html" ]; then
          echo "Load test completed. Check artifacts for details." >> performance-report.md
        else
          echo "Load test failed or not available." >> performance-report.md
        fi
        echo "" >> performance-report.md
        
        echo "## Stress Test Results" >> performance-report.md
        if [ -f "stress-results/stress-report.html" ]; then
          echo "Stress test completed. Check artifacts for details." >> performance-report.md
        else
          echo "Stress test failed or not available." >> performance-report.md
        fi
        echo "" >> performance-report.md
        
        echo "## Memory Test Results" >> performance-report.md
        if [ -f "memory-results/memory-test-results.json" ]; then
          echo "Memory test completed. Check artifacts for details." >> performance-report.md
        else
          echo "Memory test failed or not available." >> performance-report.md
        fi
        echo "" >> performance-report.md
        
        echo "## Database Performance Results" >> performance-report.md
        if [ -f "database-results/database-test-results.json" ]; then
          echo "Database test completed. Check artifacts for details." >> performance-report.md
        else
          echo "Database test failed or not available." >> performance-report.md
        fi
        echo "" >> performance-report.md

    - name: Upload performance report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance-report.md

    - name: Comment on PR with performance report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('performance-report.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
