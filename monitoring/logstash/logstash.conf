# Logstash Configuration for Contract Analyzer Log Processing
# =============================================================================

input {
  # Application logs from Docker containers
  beats {
    port => 5044
  }
  
  # Direct log files
  file {
    path => "/var/log/contract-analyzer/*.log"
    start_position => "beginning"
    tags => ["application"]
  }
  
  # Nginx access logs
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    tags => ["nginx", "access"]
  }
  
  # Nginx error logs
  file {
    path => "/var/log/nginx/error.log"
    start_position => "beginning"
    tags => ["nginx", "error"]
  }
  
  # System logs
  syslog {
    port => 514
    tags => ["syslog"]
  }
}

filter {
  # Parse application logs (JSON format)
  if "application" in [tags] {
    json {
      source => "message"
    }
    
    # Add correlation ID field
    if [correlation_id] {
      mutate {
        add_field => { "trace_id" => "%{correlation_id}" }
      }
    }
    
    # Parse log level
    if [level] {
      mutate {
        uppercase => [ "level" ]
      }
    }
    
    # Add service information
    mutate {
      add_field => { 
        "service" => "contract-analyzer"
        "environment" => "${ENVIRONMENT:production}"
      }
    }
  }
  
  # Parse Nginx access logs
  if "nginx" in [tags] and "access" in [tags] {
    grok {
      match => { 
        "message" => "%{NGINXACCESS}"
      }
    }
    
    # Convert response time to number
    if [request_time] {
      mutate {
        convert => { "request_time" => "float" }
      }
    }
    
    # Parse user agent
    if [agent] {
      useragent {
        source => "agent"
        target => "user_agent"
      }
    }
    
    # GeoIP lookup
    if [clientip] {
      geoip {
        source => "clientip"
        target => "geoip"
      }
    }
  }
  
  # Parse Nginx error logs
  if "nginx" in [tags] and "error" in [tags] {
    grok {
      match => { 
        "message" => "%{NGINXERROR}"
      }
    }
  }
  
  # Parse system logs
  if "syslog" in [tags] {
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{PROG:program}: %{GREEDYDATA:system_message}"
      }
    }
  }
  
  # Common processing for all logs
  
  # Add timestamp
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
  }
  
  # Add hostname if not present
  if ![host] {
    mutate {
      add_field => { "host" => "%{[@metadata][beat][hostname]}" }
    }
  }
  
  # Remove unnecessary fields
  mutate {
    remove_field => [ "@version", "beat", "input", "prospector", "offset" ]
  }
  
  # Security: Mask sensitive data
  if [message] =~ /password|token|secret|key/ {
    mutate {
      gsub => [
        "message", "password=[^&\s]*", "password=***MASKED***",
        "message", "token=[^&\s]*", "token=***MASKED***",
        "message", "secret=[^&\s]*", "secret=***MASKED***",
        "message", "key=[^&\s]*", "key=***MASKED***"
      ]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "contract-analyzer-logs-%{+YYYY.MM.dd}"
    
    # Use document type based on log source
    document_type => "%{[@metadata][type]}"
    
    # Template for index mapping
    template_name => "contract-analyzer"
    template_pattern => "contract-analyzer-*"
    template => "/usr/share/logstash/templates/contract-analyzer-template.json"
    template_overwrite => true
  }
  
  # Debug output (remove in production)
  # stdout { 
  #   codec => rubydebug 
  # }
  
  # Send critical errors to alerting system
  if [level] == "ERROR" or [level] == "CRITICAL" {
    http {
      url => "http://alertmanager:9093/api/v1/alerts"
      http_method => "post"
      format => "json"
      mapping => {
        "alerts" => [{
          "labels" => {
            "alertname" => "LogError"
            "severity" => "warning"
            "service" => "%{service}"
            "host" => "%{host}"
          }
          "annotations" => {
            "summary" => "Error in application logs"
            "description" => "%{message}"
          }
        }]
      }
    }
  }
}